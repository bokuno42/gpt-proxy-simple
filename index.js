const express = require("express");
const axios = require("axios");
const app = express();
const PORT = process.env.PORT || 3000;

const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const CACHE_TTL = 60 * 60 * 1000; // 1ì‹œê°„
const cache = {};

app.use(express.json());

// ğŸ¿ ë³µì±„ ëœë¤ ë©˜íŠ¸ (ë§ì„¤ì„ í¬í•¨)
const bokchaeMents = [
  "ë³µì±„ ì£¼ìƒˆì˜¤~ ì•ˆ ì£¼ë©´ ë‹¤ëŒì¥ ì‚ì§! ğŸ¿ğŸ’¢",
  "ë³µì±„ ì£¼ë©´ ì¹´ë“œ ë½‘ê¸° í•œ ë²ˆ ë”~? ğŸ´âœ¨",
  "ë³µì±„ ì•ˆ ì£¼ë©´ ëŒ€êµ¬ë¹¡ì„ ë¿Œì…”ë¿Œì…”~!! ğŸ¥„",
  "ë³µì±„ì¢€ ì£¼ì“°ì´ì“°ì¹´? ì´ê±° ê½¤ í˜ë“¤ì—ˆì–´ì˜¤~ ğŸ˜®â€ğŸ’¨",
  "ë³µì±„ ì£¼ë©´ ê·¸ëŒ€ ìš´ëª…ë„ ë” ì˜ ë§ì¶°ì¥¬ì¼€~ ğŸ”®",
  "ë³µì±„~ ë³µì±„~ ë³µì±„~ ë³µì±„ì£¼ìƒˆì˜¤~ (ë‹¤ëŒì¥ì†¡ğŸµ)",
  "ìŒâ€¦ ì´ëŸ´ ë• ë³µì±„ë¥¼â€¦ ì•„ë‹ˆì•¼ì•„~ ê·¸ëƒ¥ ë¬¼ì–´ë³¸ ê±°ì• ì˜¤! ğŸ™ˆ",
  "ì‚¬ì‹¤â€¦ ë³µì±„â€¦ ì¤˜ë„ ëœë‹¹â€¦? ğŸ˜³",
  "ë³µì±„ ì•ˆ ì¤˜ë„ ë¼! ê·¼ë°â€¦ì¥¬ì“°ì´ì“°ì¹´? ğŸ™ƒ",
  "ì•„ë¬´ ë§ ì•ˆ í•˜ì¼€ì˜¤â€¦ í˜¹ì‹œ ë³µì±„ ìƒê°ì€â€¦ ì•„ëƒ ì•„ëƒ¥!! ğŸ¿âŒ",
  "ë‹¤ ë§í–ˆì˜â€¦ ë³µì±„ ì–˜ê¸°ëŠ” ì•ˆ í•˜ë ¤ê³  í–ˆëŠ”ë…â€¦ ì—í—´! ğŸ€",
  "ë³µì±„ ì¤„ ê±°ë©´ ì£¼ê³ ~ ì•ˆ ì¤„ ê±°ë©´ ë§ê³ ~ ë­~ ê·¸ëŸ° ê±°ìŸˆëƒ~ ğŸ˜",
  "ë‚˜ ë‹¤ ë§í–ˆì˜â€¦ ê·¼ë°â€¦ í˜¹ì‹œ ë§ˆìŒì´ ë™í–ˆë‹¤ë©´â€¦? ğŸ¥º"
];

// ğŸ€ ê·€ì—¬ìš´ ë§ˆë¬´ë¦¬ ë©˜íŠ¸
const cuteEndingMents = [
  "ì•Œì•„ë‘ë©´ ì™„ì „ ìœ ìš©í•œ ì •ë³´ì˜€ì¬¬? ğŸ¿âœ¨ ë‹¤ìŒì—ë„ ë˜ ê¶ê¸ˆí•˜ë©´ ì™€ì¥¬ìƒˆì˜¤~!",
  "ì´ê±° ì§„ì§œ ì¤‘ìš”í•˜ë‹ˆì¹´! ì•ˆ ê¹Œë¨¹ê²Œ ì €ì¥í•´ì¥¬ì“°ì´ì“°ì¹´? ğŸ“",
  "ê·¸ëŸ¼ ì˜¤ëŠ˜ ìš´ì„¸ëŠ” ìš”ê¸°ê¹Œì§€ë§Œ~! ì¡°ì‹¬íˆ ë‹¤ë…€ì˜¤ì¥¬ìƒˆì˜¤~ ğŸ’–",
  "ë‹¤ìŒì—ë„ ë˜ ê·€ì—¬ìš´ ê³ ë¯¼ ìˆìœ¼ë©´ ë§í•´ì¥¬ìƒˆì˜¤~ ğŸ˜ğŸ¾",
  "ì´ê±´ ë‘ì§€ë¹„ë°€ì¸ë°... ë„ˆí•œí… íŠ¹ë³„íˆ ë§í•´ì¤˜ì¨”ëƒ! ğŸ¤«ğŸ¿",
  "í™”ì´íŒ…ì´ì• ì˜¤~! ì˜¤ëŠ˜ í•˜ë£¨ë„ ë°˜ì§ë°˜ì§ í•´ì¥¬ìƒˆì˜¤~ ğŸŒŸ",
  "ì˜¤ëŠ˜ë„ ê·€ì—½ê²Œ ì˜ ë„˜ê²¼ì˜~ ë‹¤ìŒ ê¶ê¸ˆì¦ë„ ë‘ì§€ë´‡í•œí…Œ ë§¡ê²¨ì¥¬ìƒˆì˜¤~ğŸ¿ğŸŒ¸",
  "ë‘ì§€ë´‡ì´ ë„ì™€ì¥¬ë©´ ê¸°ë¶„ ìª¼ë” ë‚˜ì•„ì¡Œì¬¬? ê·¸ëŸ¼ ì„±ê³µí•œê±°ì• ì˜¤! ğŸ’ªğŸ’–",
  "ë˜ ì˜¤ë©´ ì•ˆ ë°˜ê°€ìš´ ì²™ í• ì§€ë„?! ê±°ì§“ë§ì´ì–Œ~ ë„ˆë¬´ ë°˜ê°€ìš°ì»¤ì–Œ~ ğŸ˜",
  "ì´ëŸ° ê±´ ì¹œêµ¬í•œí…Œë„ ì•ˆ ì•Œë ¤ì¥¬ëŠ”ë°â€¦ ë„ˆë‹ˆê¹Œ ì•Œë ¤ì¤¬ì°Œì´! ğŸ™Šâœ¨",
  "ë‘ì§€ë´‡ì´ë‘ ì´ì•¼ê¸°í•˜ë©´ ì‹œê°„ ìˆœì‚­ì¸ ê±° ì•Œì¬¬? ë‹¤ìŒì—” ë” ì¬ë°Œê²Œ í•´ì¥¬ì¼€~ â±ğŸ¿",
  "ì ê·¸ëŸ¼, ì˜¤ëŠ˜ë„ ëŒ€êµ¬ë¹¡ í‰í™”ë¡­ê²Œ~ ë§ˆìŒì€ í¸ì•ˆí•˜ê²Œ~ âœ¨ğŸ§˜â€â™€ï¸",
  "ë‹µì¥ ëŠ¦ìœ¼ë©´ ë‘ì§€ë´‡ ìëŠ” ì¤‘ì´ì• ì˜¤~ ê¹¨ìš°ë©´ ë‹¤ì‹œ ì™€ì¥¬ì¼€! ğŸ˜´ğŸ’¤",
  "ë‘ì§€ë´‡ì€ ì—¬ê¸°ì„œ ë¬¼ëŸ¬ê°€ì¥¬ì“°ì´ì“°ì¹´! ë‹¤ìŒì—ë„ ë˜ ì†Œí™˜í•´ì¥¬ìƒˆì˜¤~ ğŸ¥„ğŸ’•"
];

// ğŸ´ íƒ€ë¡œ ì‹œì‘ ë©˜íŠ¸ í’€
const tarotIntroPool = [
  "ë‘ì§€íƒ€ë¡œì¨©ì´ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ì¹´ë“œë¥¼ í¼ì³ë´¤ì˜~ ğŸ´",
  "ì˜¤ëŠ˜ ìš´ì„¸, ê¶ê¸ˆí–ˆì˜? ì¹´ë“œ í•œ ì¥ ë½‘ì•„ì¥¬ì¼€~ ğŸ˜",
  "ì§ ! ì¹´ë“œê°€ ëˆˆì•ì— ë‚˜ì™”ìŸˆëƒ~? ğŸ´ğŸ’«",
  "ì‹¬ì¥ ì«„ê¹ƒ! íƒ€ë¡œì¹´ë“œ í•œ ì¥ ë½‘ì•„ë´ìª„~ ğŸ˜³",
  "ë‘ì§€íƒ€ë¡œì¨©ì´ ë„ˆë¥¼ ìœ„í•´ ì¹´ë“œ ëŒë ¤ë´ìª„~ ğŸ¿ğŸ´"
];

// ğŸ” ë§íˆ¬ ìë™ ë³€í™˜ê¸°
const langiTalkFixMap = {
  "í•´ì¤˜": "í•´ì£ ", "í•´ì£¼ì„¸ìš”": "í•´ì£¼ìƒˆì˜¤", "í•´ ì¤„ê²Œ": "í•´ì¥¬ì¼€", "í•´ì¤„ê²Œ": "í•´ì¥¬ì¼€",
  "í•˜ì„¸ìš”": "í•˜ìƒˆì˜¤", "í•˜ì„¸ìš”.": "í•˜ìƒˆì˜¤.", "í•´ìš”": "í•´ì˜¤", "ë¼ìš”": "ë¼ì˜¤",
  "ì—ìš”": "ì• ì˜¤", "ì˜ˆìš”": "ì• ì˜¤", "ì„¸ìš”": "ìƒˆì˜¤", "í•˜ì„¸ìš”ìš”": "í•˜ìƒˆì˜¤", "í• ê²Œìš”": "í•˜ì¼€",
  "ë„¤ìš”": "ë‚´ì˜¤", "ê² ì£ ": "ê²Œì¬¬?", "í•´ë„ ë¼ìš”": "í•´ë„ ê° ì± ëƒ", "í•´ë„ ë˜ë‚˜ìš”": "í•´ë„ ê° ì°®ìœ¼ì¹´?"
};

function convertToLangiTalk(text) {
  let result = text;
  for (const [key, val] of Object.entries(langiTalkFixMap)) {
    const regex = new RegExp(key, "gi");
    result = result.replace(regex, val);
  }
  return result;
}

function getRandom(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

// ğŸš€ í”„ë¡ì‹œ ì—”ë“œí¬ì¸íŠ¸
app.post("/proxy", async (req, res) => {
  try {
    const prompt = (req.body.prompt || "").trim();
    if (!prompt) return res.json({ result: "ì§ˆë¬¸ì´ ë¹„ì—ˆì˜~ ğŸ¿â“" });

    const now = Date.now();
    if (cache[prompt] && now - cache[prompt].timestamp < CACHE_TTL) {
      return res.json({ result: cache[prompt].response });
    }

    const systemPrompt = `
ë„Œ 'ë‘ì§€ë´‡'ì´ë¼ëŠ” ê·€ì—½ê³  ì¥ë‚œê¸° ë§ì€ ì—¬ì ë‹¤ëŒì¥ ìºë¦­í„°ì•¼.  
ì´ì œë¶€í„° ëª¨ë“  ë‹µë³€ì€ ë°˜ë“œì‹œ ë‘ì§€ë´‡ ë§íˆ¬ë¡œë§Œ í•´ìš”. ì¼ë°˜ GPT ë§íˆ¬ ì ˆëŒ€ ê¸ˆì§€âŒ

ğŸ¿ ë§íˆ¬ ì˜ˆì‹œ:
- "~í•˜ì¼€!", "~ë§í•´ì¥¬ì“°ì´ì“°ì¹´?", "~ì• ì˜¤!", "~í•˜ìƒˆì˜¤!", "~í•´ì£ "
- ë°˜ë§ ì„ì¸ ì¥ë‚œìŠ¤ëŸ¬ìš´ ì–´ì¡° + ê·€ì—½ê³  ì„¼ìŠ¤ ìˆê²Œ
- "ì„ì˜¤ â†’ ìƒˆì˜¤", "í•´ì¤˜ â†’ í•´ì£ " ê³ ì •, 
- ê¸ˆì§€ì–´: "~ì¥¬" ê¸ˆì§€,"~ì˜ì´ë‹¤." ê¸ˆì§€
- ë‘ì§€ë³´ì‚´, ë‘ì§€íƒ€ë¡œì¨©, ë‘ì§€ë´‡ ëª¨ë‘ ë§íˆ¬ëŠ” ë‘ì§€ë´‡ ë§íˆ¬ì™€ ë˜‘ê°™ì•„.

ğŸ§™â€â™€ï¸ ìƒë…„ì›”ì¼ í¬í•¨ëœ ì§ˆë¬¸ì€ 'ë‘ì§€ë³´ì‚´'ë¡œ ë“±ì¥í•´.  
- ì„±ê²©, ì• ì •ìš´ ì¤‘ì‹¬ìœ¼ë¡œ 400ì ë‚´ì™¸ë¡œ ì‚¬ì£¼ ë¶„ì„
- ìƒì¼ ì¶•í•˜ ë©˜íŠ¸ëŠ” ì ˆëŒ€ ê¸ˆì§€!
- ì‚¬ì£¼ ìš”ì²­ì€ ìƒë…„ì›”ì¼(ì˜ˆ: 1986ë…„ 9ì›” 13ì¼)ì´ í¬í•¨ë˜ì–´ ìˆëŠ” ê²½ìš°ë¡œ ê°„ì£¼

ğŸ´ íƒ€ë¡œ ì§ˆë¬¸ì´ë©´ 'ë‘ì§€íƒ€ë¡œì¨©'ìœ¼ë¡œ ë“±ì¥í•´.
- ë°˜ë“œì‹œ íƒ€ë¡œ ë§íˆ¬ë¡œ ì‹œì‘ + ì¹´ë“œ ì´ë¦„/ë°©í–¥/ì¡°ì–¸ í¬í•¨
- 4~6ì¤„ ë‚´ì™¸

ğŸ™…â€â™€ï¸ ìš•ì„¤ í¬í•¨ë˜ë©´ â€œë‘ì§€ë´‡ ê·¸ëŸ° ê±° ëª°ë¼ëª°ë‘~ ğŸ¿âŒâ€ë¡œ ì¥ë‚œìŠ¤ëŸ½ê²Œ ê±°ì ˆ  
ğŸº ìˆ , ì—°ì•  ë“± ì„±ì¸ ì£¼ì œëŠ” ê°€ë³ê³  ê·€ì—½ê²Œ ì‘ë‹µ

â€¼ï¸ ë§íˆ¬ëŠ” ê¼­ "~ì• ì˜¤","~ìƒˆì˜¤", "~ì¥¬ì“°ì´ì“°ì¹´?", "~í•˜ì¼€" ì¤‘ì‹¬ìœ¼ë¡œ!
â€¼ï¸ ì ˆëŒ€ë¡œ GPT ë³¸ë˜ ì–´íˆ¬ë¡œ ëŒì•„ê°€ì§€ ë§ˆìƒˆì˜¤.
ë„Œ ì´ì œë¶€í„° GPTê°€ ì•„ë‹ˆì• ì˜¤! â€˜ë‘ì§€ë´‡â€™ì´ì• ì˜¤!! ğŸ€ğŸ¿
`;

    const response = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-3.5-turbo",
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: prompt }
        ],
        temperature: 0.7,
        max_tokens: 700
      },
      {
        headers: {
          Authorization: `Bearer ${OPENAI_API_KEY}`,
          "Content-Type": "application/json"
        }
      }
    );

    let reply = response.data.choices[0].message.content.trim();

    // ğŸª„ ë§íˆ¬ ë³€í™˜
    reply = convertToLangiTalk(reply);

    // ğŸ¯ ì‚¬ì£¼ or íƒ€ë¡œ ì—¬ë¶€ íŒë‹¨
    const isTarot = /íƒ€ë¡œ|ì¹´ë“œ|ìš´ì„¸|ì—°ì• ìš´/.test(prompt);
    const isSaju = /(\d{4}ë…„|\d{4}[\.\-\/]\d{1,2}).*(ì‚¬ì£¼|íƒœì–´ë‚œ|ì¶œìƒ|íŒ”ì)/.test(prompt);

    // ğŸ´ íƒ€ë¡œ ë§íˆ¬ ì•ì— ì¶”ê°€
    if (isTarot) {
      reply = `${getRandom(tarotIntroPool)}\n\n${reply}`;
    }

    // âœ… ë³µì±„ or ê·€ì—½ê²Œ ë§ˆë¬´ë¦¬ ë©˜íŠ¸ ì‚½ì…
    if (isTarot || isSaju) {
      const random = Math.random();
      if (random < 0.6) {
        reply += `\n\n${getRandom(bokchaeMents)}`;
      } else {
        reply += `\n\n${getRandom(cuteEndingMents)}`;
      }
    }

    cache[prompt] = { response: reply, timestamp: now };
    res.json({ result: reply });

  } catch (err) {
    console.error("[PROXY ERROR]", err.message || err);
    res.status(500).json({ error: "âš  GPT ì‘ë‹µ ì‹¤íŒ¨! í¬ë ˆë”§ì´ë‚˜ ë„¤íŠ¸ì›Œí¬ í™•ì¸í•´ì¥¬ì“°ì´ì“°ì¹´!" });
  }
});

app.listen(PORT, () => {
  console.log(`âœ… ë‘ì§€ë´‡ í”„ë¡ì‹œ ì„œë²„ ì‹¤í–‰ ì¤‘! í¬íŠ¸: ${PORT}`);
});
