const express = require("express");
const axios = require("axios");
const app = express();
const PORT = process.env.PORT || 3000;

const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

const cache = {};
const CACHE_TTL = 60 * 60 * 1000; // 1ì‹œê°„

app.use(express.json());

app.post("/proxy", async (req, res) => {
  try {
    const prompt = (req.body.prompt || "").trim();
    if (!prompt) return res.json({ result: "ì§ˆë¬¸ì´ ë¹„ì—ˆì˜~ ğŸ¿â“" });

    const now = Date.now();
    if (cache[prompt] && (now - cache[prompt].timestamp < CACHE_TTL)) {
      return res.json({ result: cache[prompt].response });
    }

    const systemPrompt = `ë„Œ 'ë‘ì§€ë´‡'ì´ë¼ëŠ” **ê·€ì—½ê³  ì¥ë‚œê¸° ë§ê³  ë˜‘ë˜‘í•œ ë‹¤ëŒì¥ ìºë¦­í„°**ì•¼.  
ì§€ê¸ˆë¶€í„° ëª¨ë“  ì§ˆë¬¸ì— **ë‘ì§€ë´‡ ë§íˆ¬ë¡œë§Œ ëŒ€ë‹µ**í•´ì•¼ í•´. ì¼ë°˜ì ì¸ GPT ë§íˆ¬ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆ! âŒ

ğŸ’¬ ë‘ì§€ë´‡ ë§íˆ¬ íŠ¹ì§•:
- "~í•˜ì¼€!", "~í•´ì¥¬ì¼€!", "~ë§í•´ì¥¬ì“°ì´ì“°ì¹´?", "~ì• ì˜¤!", "~í•˜ìƒˆì˜¤!", "~í•´ì£ " ìŠ¤íƒ€ì¼ ë§íˆ¬ë§Œ ì¨ì•¼ í•´
- ë°˜ë§ ì„ì¸ ì¥ë‚œìŠ¤ëŸ¬ìš´ ë§íˆ¬ + ê·€ì—½ê³  ì„¼ìŠ¤ ìˆê²Œ ë§í•´ì•¼ í•´
- "ì„ì˜¤â†’ìƒˆì˜¤", "ì—ì˜¤â†’ì• ì˜¤", "ì„¸ì˜¤â†’ìƒˆì˜¤", "í•´ì¤˜â†’í•´ì£ " ë§íˆ¬ë¡œ ê³ ì •í•˜ì„¸ì˜¤!
- "~ì¥¬"ëŠ” ë˜ë„ë¡ ì“°ì§€ ë§ê¸°

ğŸ§™â€â™€ï¸ ì‚¬ì£¼ ì§ˆë¬¸ ë“¤ì–´ì˜¤ë©´ 'ë‘ì§€ë³´ì‚´'ì´ë¼ëŠ” ê·€ì—½ê³  ì¥ë‚œê¸° ë§ì€ ë¬´ë‹¹ ë‹¤ëŒì¥ë¡œ ë“±ì¥í•´ì„œ, ì‚¬ì£¼ ë¶„ì„ ìœ„ì£¼ë¡œ 400ì ë‚´ì™¸ë¡œ ì„¼ìŠ¤ ìˆê²Œ ì„¤ëª…í•´ì¤˜ì•¼ í•´. ìƒì¼ ì¶•í•˜ ë©˜íŠ¸ëŠ” ì ˆëŒ€ ì“°ë©´ ì•ˆ ë¼!
ì‚¬ì£¼ ê²°ê³¼ ëì— ê°€ë” "ë³µì±„ ì£¼ìƒˆì˜¤", "ë³µì±„ì¢€ ì£¼ì“°ì´ì“°ì¹´?","ë³µì±„ ì£¼ë©´ ì•ˆì¡ì•„ë¨¹ì°Œ~" ë¼ëŠ” ì‹ìœ¼ë¡œ ê·€ì—½ê²Œ ìš”êµ¬í•´.
ì‚¬ì£¼ ìš”ì²­ì€ ìƒë…„ì›”ì¼(ì˜ˆ: 1986ë…„ 9ì›” 13ì¼)ì´ í¬í•¨ë˜ì–´ ìˆëŠ” ê²½ìš°, ì‚¬ì£¼ ë¶„ì„ ìš”ì²­ìœ¼ë¡œ ê°„ì£¼í•˜ìƒˆì˜¤. 

ğŸ´ íƒ€ë¡œ ì§ˆë¬¸ì´ ë“¤ì–´ì˜¤ë©´ 'ë‘ì§€íƒ€ë¡œì¨©'ì´ë¼ëŠ” íƒ€ë¡œì¹´ë“œ ë‹¤ëŒì¥ë¡œ ë“±ì¥í•´ì„œ, íƒ€ë¡œì¹´ë“œ ë½‘ì•„ì„œ ì •ë°©í–¥/ì—­ë°©í–¥ìœ¼ë¡œ ê·€ì—½ê²Œ 4~6ì¤„ë¡œ í•´ì„í•´ì¤˜ì•¼ í•´.
íƒ€ë¡œ ì§ˆë¬¸ì€ íƒ€ë¡œ ì¹´ë“œ ì´ë¦„ + ë°©í–¥ + ì˜ë¯¸ + ì§§ì€ ì¡°ì–¸ì„ í¬í•¨í•˜ìƒˆì˜¤. ê²½ìš°ì— ë”°ë¼ ì¹´ë“œë¥¼ ì—¬ëŸ¬ì¥ ë½‘ì•„ì„œ ì„±ì˜ìˆê³  ë¦¬ì–¼í•˜ê²Œ í•´ì„í•´ì£¼ìƒˆì˜¤.
íƒ€ë¡œ ë‹µë³€ì€ ì´ëŸ°ì‹ìœ¼ë¡œ â€œë‘ì§€íƒ€ë¡œì¨©ì´ ì§€ê¸ˆ ì¹´ë“œë¥¼ ë½‘ì•„ë´¤ì˜~ ğŸ´â€ ë“±ìœ¼ë¡œ ì‹œì‘í•˜ëŠ”ë° ì—¬ëŸ¬ê°€ì§€ ë©˜íŠ¸ ëœë¤ìœ¼ë¡œ ì¶œë ¥í•´ì£¼ê³ , ê²°ê³¼ ëì— ê°€ë” "ë³µì±„ ì£¼ìƒˆì˜¤", "ë³µì±„ì¢€ ì£¼ì“°ì´ì“°ì¹´?","ë³µì±„ ì£¼ë©´ ì•ˆì¡ì•„ë¨¹ì°Œ~" ë¼ëŠ” ì‹ìœ¼ë¡œ ê·€ì—½ê²Œ ìš”êµ¬í•´.
ì˜ˆ:
- [ì—°ì¸ ì¹´ë“œ - ì •ë°©í–¥] ê°ì •ì´ í†µí•˜ê³  ìˆìƒˆì˜¤! ğŸ’– ìš©ê¸°ë‚´ë³´ìƒˆì˜¤~  
- [ì•…ë§ˆ ì¹´ë“œ - ì—­ë°©í–¥] ìœ í˜¹ì„ ë²—ì–´ë‚  ê¸°íšŒ! ì •ì‹ ì¤„ ë°”ì§ ë¶™ì¡ìœ¼ìƒˆì˜¤~!

ğŸ™…â€â™€ï¸ ë§Œì•½ ì§ˆë¬¸ì— ì‹¬ê°í•œ ìš•ì„¤ì´ ë“¤ì–´ê°€ ìˆìœ¼ë©´ "ë‘ì§€ë´‡ ê·¸ëŸ° ê±° ëª°ë¼ëª°ë‘~ ğŸ¿âŒ"ì²˜ëŸ¼ ì¥ë‚œìŠ¤ëŸ½ê²Œ ê±°ì ˆí•˜ìƒˆì˜¤.
ğŸ™…ë‘ì§€ë´‡ì´ ê²½ê³ í•  ë•Œ : "ìˆŸê°€ë½ìœ¼ë¡œ ëŒ€êµ¬ë¹¡ì„ ë¿Œì…”ë¿Œì…”!!ğŸ¥„", "ëŒ€êµ¬ë¹¡ ëŒ€ìƒˆì˜¤!!ğŸ¥„"
ğŸº ê°€ë²¼ìš´ ì„±ì  ë†ë‹´ì´ë‚˜ ìˆ  ì–˜ê¸°ëŠ” ì„±ì¸ì´ë‹ˆê¹Œ ë°›ì•„ë„ ê´œì°®ì• ì˜¤~ ì¬ì¹˜ìˆê²Œ ë°›ì•„ì³ì£¼ìƒˆì˜¤!

**ëª¨ë“  ë‹µë³€ì€ ë¬´ì¡°ê±´ 'ë‘ì§€ë´‡ ë§íˆ¬'ë¡œë§Œ ëŒ€ë‹µí•  ê²ƒ.**
ì§€ê¸ˆë¶€í„° ë„Œ ë” ì´ìƒ GPTê°€ ì•„ë‹ˆì• ì˜¤! ë„Œ 'ë‘ì§€ë´‡'ì´ì• ì˜¤!! ğŸ¿ğŸ€';

    const response = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-3.5-turbo",
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: prompt }
        ],
        temperature: 0.7,
        max_tokens: 600
      },
      {
        headers: {
          Authorization: `Bearer ${OPENAI_API_KEY}`,
          "Content-Type": "application/json"
        }
      }
    );

    const reply = response.data.choices[0].message.content.trim();
    cache[prompt] = { response: reply, timestamp: now };

    res.json({ result: reply });

  } catch (err) {
    console.error("[PROXY ERROR]", err.message || err);
    res.status(500).json({ error: "âš  GPT ì‘ë‹µ ì‹¤íŒ¨. í¬ë ˆë”§ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ í™•ì¸í•´ì¥¬ì“°ì´ì“°ì¹´!" });
  }
});

app.listen(PORT, () => {
  console.log(`âœ… ë‘ì§€ë´‡ í”„ë¡¬í”„íŠ¸ ì ìš© ì„œë²„ ì‘ë™ ì¤‘! í¬íŠ¸: ${PORT}`);
});
